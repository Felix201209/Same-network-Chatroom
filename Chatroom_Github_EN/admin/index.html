<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chatroom Admin Panel</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a2e;
      color: #eee;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    
    header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    header h1 {
      font-size: 24px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: #16213e;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    }
    
    .stat-card i {
      font-size: 24px;
      margin-bottom: 10px;
      color: #667eea;
    }
    
    .stat-card .value {
      font-size: 28px;
      font-weight: bold;
      color: #fff;
    }
    
    .stat-card .label {
      font-size: 12px;
      color: #888;
      margin-top: 5px;
    }
    
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .tab-btn {
      background: #16213e;
      border: none;
      color: #888;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }
    
    .tab-btn:hover {
      background: #1f2b4d;
    }
    
    .tab-btn.active {
      background: #667eea;
      color: #fff;
    }
    
    .panel {
      display: none;
      background: #16213e;
      border-radius: 12px;
      padding: 20px;
    }
    
    .panel.active {
      display: block;
    }
    
    .panel h2 {
      margin-bottom: 20px;
      font-size: 18px;
      color: #667eea;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #2a2a4a;
    }
    
    th {
      color: #888;
      font-weight: 500;
      font-size: 12px;
      text-transform: uppercase;
    }
    
    tr:hover {
      background: #1f2b4d;
    }
    
    .badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .badge-online {
      background: #10b981;
      color: #fff;
    }
    
    .badge-offline {
      background: #6b7280;
      color: #fff;
    }
    
    .badge-banned {
      background: #ef4444;
      color: #fff;
    }
    
    .badge-muted {
      background: #f59e0b;
      color: #fff;
    }
    
    .role-badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
    }
    
    .action-btn {
      background: none;
      border: 1px solid #444;
      color: #888;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      margin-right: 5px;
      transition: all 0.3s;
    }
    
    .action-btn:hover {
      border-color: #667eea;
      color: #667eea;
    }
    
    .action-btn.danger:hover {
      border-color: #ef4444;
      color: #ef4444;
    }
    
    .action-btn.success:hover {
      border-color: #10b981;
      color: #10b981;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: #16213e;
      padding: 30px;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal-content h3 {
      margin-bottom: 20px;
      color: #667eea;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: #888;
      font-size: 14px;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #2a2a4a;
      border-radius: 8px;
      background: #1a1a2e;
      color: #fff;
      font-size: 14px;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .form-row {
      display: flex;
      gap: 10px;
    }
    
    .form-row .form-group {
      flex: 1;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }
    
    .btn-primary {
      background: #667eea;
      color: #fff;
    }
    
    .btn-primary:hover {
      background: #5a6fd6;
    }
    
    .btn-secondary {
      background: #2a2a4a;
      color: #fff;
    }
    
    .btn-danger {
      background: #ef4444;
      color: #fff;
    }
    
    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
    }
    
    .chat-list {
      max-height: 400px;
      overflow-y: auto;
    }
    
    .chat-item {
      padding: 15px;
      border-bottom: 1px solid #2a2a4a;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .chat-item:hover {
      background: #1f2b4d;
    }
    
    .chat-item h4 {
      font-size: 14px;
      margin-bottom: 5px;
    }
    
    .chat-item p {
      font-size: 12px;
      color: #888;
    }
    
    .message-list {
      max-height: 500px;
      overflow-y: auto;
      padding: 10px;
      background: #1a1a2e;
      border-radius: 8px;
    }
    
    .message-item {
      padding: 10px;
      margin-bottom: 10px;
      background: #16213e;
      border-radius: 8px;
    }
    
    .message-item .sender {
      font-size: 12px;
      color: #667eea;
      margin-bottom: 5px;
    }
    
    .message-item .content {
      font-size: 14px;
    }
    
    .message-item .time {
      font-size: 11px;
      color: #666;
      margin-top: 5px;
    }
    
    .search-box {
      margin-bottom: 20px;
    }
    
    .search-box input {
      width: 100%;
      padding: 12px;
      border: 1px solid #2a2a4a;
      border-radius: 8px;
      background: #1a1a2e;
      color: #fff;
      font-size: 14px;
    }
    
    .permission-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .permission-item {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 5px 10px;
      background: #1a1a2e;
      border-radius: 4px;
      font-size: 12px;
    }
    
    .permission-item input {
      width: auto;
    }
    
    .refresh-btn {
      background: #667eea;
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .refresh-btn:hover {
      background: #5a6fd6;
    }
    
    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      table {
        font-size: 12px;
      }
      
      th, td {
        padding: 8px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1><i class="fas fa-shield-alt"></i> Chatroom Admin Panel</h1>
      <button class="refresh-btn" onclick="loadStats()"><i class="fas fa-sync-alt"></i> Refresh</button>
    </header>
    
    <div class="stats-grid">
      <div class="stat-card">
        <i class="fas fa-users"></i>
        <div class="value" id="totalUsers">0</div>
        <div class="label">Total Users</div>
      </div>
      <div class="stat-card">
        <i class="fas fa-circle" style="color: #10b981;"></i>
        <div class="value" id="onlineUsers">0</div>
        <div class="label">Online Users</div>
      </div>
      <div class="stat-card">
        <i class="fas fa-comments"></i>
        <div class="value" id="totalRooms">0</div>
        <div class="label">Group Chats</div>
      </div>
      <div class="stat-card">
        <i class="fas fa-envelope"></i>
        <div class="value" id="totalMessages">0</div>
        <div class="label">Total Messages</div>
      </div>
      <div class="stat-card">
        <i class="fas fa-ban"></i>
        <div class="value" id="bannedUsers">0</div>
        <div class="label">Banned Users</div>
      </div>
      <div class="stat-card">
        <i class="fas fa-volume-mute"></i>
        <div class="value" id="mutedUsers">0</div>
        <div class="label">Muted Users</div>
      </div>
    </div>
    
    <div class="tabs">
      <button class="tab-btn active" onclick="showPanel('users')"><i class="fas fa-users"></i> User Management</button>
      <button class="tab-btn" onclick="showPanel('messages')"><i class="fas fa-comments"></i> Message History</button>
      <button class="tab-btn" onclick="showPanel('rooms')"><i class="fas fa-door-open"></i> Group Management</button>
      <button class="tab-btn" onclick="showPanel('roles')"><i class="fas fa-user-tag"></i> Role Management</button>
    </div>
    
    <!-- User Management -->
    <div class="panel active" id="usersPanel">
      <h2>User List</h2>
      <div class="search-box">
        <input type="text" id="userSearch" placeholder="Search users..." oninput="filterUsers()">
      </div>
      <table>
        <thead>
          <tr>
            <th>Username</th>
            <th>Nickname</th>
            <th>Role</th>
            <th>Status</th>
            <th>Registered</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="userTableBody">
        </tbody>
      </table>
    </div>
    
    <!-- Message History -->
    <div class="panel" id="messagesPanel">
      <h2>Chat History</h2>
      <div style="display: grid; grid-template-columns: 300px 1fr; gap: 20px;">
        <div>
          <h4 style="margin-bottom: 10px; color: #888;">Chat List</h4>
          <div class="chat-list" id="chatList"></div>
        </div>
        <div>
          <h4 style="margin-bottom: 10px; color: #888;">Message Details</h4>
          <div class="message-list" id="messageList">
            <p style="color: #666; text-align: center; padding: 20px;">Select a chat to view messages</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Group Management -->
    <div class="panel" id="roomsPanel">
      <h2>Group Chat List</h2>
      <table>
        <thead>
          <tr>
            <th>Group Name</th>
            <th>Owner</th>
            <th>Members</th>
            <th>Created</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="roomTableBody">
        </tbody>
      </table>
    </div>
    
    <!-- Role Management -->
    <div class="panel" id="rolesPanel">
      <h2>Role Management</h2>
      <button class="btn btn-primary" onclick="showCreateRoleModal()" style="margin-bottom: 20px;">
        <i class="fas fa-plus"></i> Create New Role
      </button>
      <table>
        <thead>
          <tr>
            <th>Role Name</th>
            <th>Level</th>
            <th>Badge</th>
            <th>Permissions</th>
            <th>Type</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="roleTableBody">
        </tbody>
      </table>
    </div>
  </div>
  
  <!-- Ban Modal -->
  <div class="modal" id="banModal">
    <div class="modal-content">
      <h3><i class="fas fa-ban"></i> Ban User</h3>
      <input type="hidden" id="banUserOdp">
      <p style="margin-bottom: 15px;">User: <strong id="banUserName"></strong></p>
      <div class="form-group">
        <label>Ban Reason</label>
        <textarea id="banReason" rows="3" placeholder="Enter ban reason..."></textarea>
      </div>
      <div class="form-group">
        <label>Ban Duration</label>
        <select id="banDuration">
          <option value="3600000">1 Hour</option>
          <option value="86400000">1 Day</option>
          <option value="604800000">7 Days</option>
          <option value="2592000000">30 Days</option>
          <option value="permanent">Permanent</option>
        </select>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal('banModal')">Cancel</button>
        <button class="btn btn-danger" onclick="confirmBan()">Confirm Ban</button>
      </div>
    </div>
  </div>
  
  <!-- Mute Modal -->
  <div class="modal" id="muteModal">
    <div class="modal-content">
      <h3><i class="fas fa-volume-mute"></i> Mute User</h3>
      <input type="hidden" id="muteUserOdp">
      <p style="margin-bottom: 15px;">User: <strong id="muteUserName"></strong></p>
      <div class="form-group">
        <label>Mute Reason</label>
        <textarea id="muteReason" rows="3" placeholder="Enter mute reason..."></textarea>
      </div>
      <div class="form-group">
        <label>Mute Duration</label>
        <select id="muteDuration">
          <option value="300000">5 Minutes</option>
          <option value="1800000">30 Minutes</option>
          <option value="3600000">1 Hour</option>
          <option value="86400000">1 Day</option>
          <option value="permanent">Permanent</option>
        </select>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal('muteModal')">Cancel</button>
        <button class="btn btn-danger" onclick="confirmMute()">Confirm Mute</button>
      </div>
    </div>
  </div>
  
  <!-- Set Role Modal -->
  <div class="modal" id="roleModal">
    <div class="modal-content">
      <h3><i class="fas fa-user-tag"></i> Set Role</h3>
      <input type="hidden" id="roleUserOdp">
      <p style="margin-bottom: 15px;">User: <strong id="roleUserName"></strong></p>
      <div class="form-group">
        <label>Select Role</label>
        <select id="roleSelect"></select>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal('roleModal')">Cancel</button>
        <button class="btn btn-primary" onclick="confirmSetRole()">Confirm</button>
      </div>
    </div>
  </div>
  
  <!-- Change Password Modal -->
  <div class="modal" id="passwordModal">
    <div class="modal-content">
      <h3><i class="fas fa-key"></i> Change User Password</h3>
      <input type="hidden" id="passwordUserOdp">
      <p style="margin-bottom: 15px;">User: <strong id="passwordUserName"></strong></p>
      <div class="form-group">
        <label>New Password</label>
        <input type="password" id="newPasswordInput" placeholder="Enter new password (min 6 characters)">
      </div>
      <div class="form-group">
        <label>Confirm Password</label>
        <input type="password" id="confirmPasswordInput" placeholder="Re-enter new password">
      </div>
      <p style="color: #f59e0b; font-size: 12px; margin-bottom: 10px;">
        <i class="fas fa-exclamation-triangle"></i> After changing password, user will be forced offline
      </p>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal('passwordModal')">Cancel</button>
        <button class="btn btn-primary" onclick="confirmChangePassword()">Confirm Change</button>
      </div>
    </div>
  </div>
  
  <!-- Create Role Modal -->
  <div class="modal" id="createRoleModal">
    <div class="modal-content">
      <h3><i class="fas fa-plus"></i> Create New Role</h3>
      <div class="form-group">
        <label>Role Name</label>
        <input type="text" id="newRoleName" placeholder="e.g. VIP_PLUS">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Color</label>
          <input type="color" id="newRoleColor" value="#667eea">
        </div>
        <div class="form-group">
          <label>Level (0-99)</label>
          <input type="number" id="newRoleLevel" value="10" min="0" max="99">
        </div>
      </div>
      <div class="form-group">
        <label>Badge Display</label>
        <input type="text" id="newRoleBadge" placeholder="e.g. üåü Premium Member">
      </div>
      <div class="form-group">
        <label>Permissions</label>
        <div class="permission-list">
          <label class="permission-item">
            <input type="checkbox" value="ban"> Ban
          </label>
          <label class="permission-item">
            <input type="checkbox" value="mute"> Mute
          </label>
          <label class="permission-item">
            <input type="checkbox" value="view_chats"> View Chats
          </label>
          <label class="permission-item">
            <input type="checkbox" value="manage_users"> Manage Users
          </label>
          <label class="permission-item">
            <input type="checkbox" value="manage_rooms"> Manage Groups
          </label>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal('createRoleModal')">Cancel</button>
        <button class="btn btn-primary" onclick="confirmCreateRole()">Create</button>
      </div>
    </div>
  </div>

  <script>
    let allUsers = [];
    let allRoles = { builtIn: {}, custom: {} };
    
    // Load statistics
    async function loadStats() {
      try {
        const res = await fetch('/api/stats');
        const stats = await res.json();
        document.getElementById('totalUsers').textContent = stats.users;
        document.getElementById('onlineUsers').textContent = stats.online;
        document.getElementById('totalRooms').textContent = stats.rooms;
        document.getElementById('totalMessages').textContent = stats.messages;
        document.getElementById('bannedUsers').textContent = stats.banned;
        document.getElementById('mutedUsers').textContent = stats.muted;
      } catch (e) {
        console.error('Failed to load stats:', e);
      }
    }
    
    // Load user list
    async function loadUsers() {
      try {
        const res = await fetch('/api/users');
        allUsers = await res.json();
        renderUsers(allUsers);
      } catch (e) {
        console.error('Failed to load users:', e);
      }
    }
    
    function renderUsers(users) {
      const tbody = document.getElementById('userTableBody');
      tbody.innerHTML = users.map(u => `
        <tr>
          <td>${escapeHtml(u.username)}</td>
          <td>${escapeHtml(u.nickname)}</td>
          <td>
            <span class="role-badge" style="background: ${u.roleInfo?.color || '#666'}; color: #fff;">
              ${u.roleInfo?.badge || u.role}
            </span>
          </td>
          <td>
            ${u.online ? '<span class="badge badge-online">Online</span>' : '<span class="badge badge-offline">Offline</span>'}
            ${u.banned ? '<span class="badge badge-banned">Banned</span>' : ''}
            ${u.muted ? '<span class="badge badge-muted">Muted</span>' : ''}
          </td>
          <td>${new Date(u.createdAt).toLocaleString()}</td>
          <td>
            ${u.role !== 'SUPER_ADMIN' ? `
              ${u.banned ? 
                `<button class="action-btn success" onclick="unbanUser('${u.odp}')">Unban</button>` :
                `<button class="action-btn danger" onclick="showBanModal('${u.odp}', '${escapeHtml(u.nickname)}')">Ban</button>`
              }
              ${u.muted ?
                `<button class="action-btn success" onclick="unmuteUser('${u.odp}')">Unmute</button>` :
                `<button class="action-btn danger" onclick="showMuteModal('${u.odp}', '${escapeHtml(u.nickname)}')">Mute</button>`
              }
              <button class="action-btn" onclick="showRoleModal('${u.odp}', '${escapeHtml(u.nickname)}', '${u.role}')">Set Role</button>
              <button class="action-btn" onclick="showPasswordModal('${u.odp}', '${escapeHtml(u.nickname)}')" title="Change Password">üîë</button>
              <button class="action-btn danger" onclick="deleteUser('${u.odp}', '${escapeHtml(u.nickname)}')" title="Delete User">üóëÔ∏è</button>
            ` : '<span style="color: #888;">-</span>'}
          </td>
        </tr>
      `).join('');
    }
    
    function filterUsers() {
      const query = document.getElementById('userSearch').value.toLowerCase();
      const filtered = allUsers.filter(u => 
        u.username.toLowerCase().includes(query) || 
        u.nickname.toLowerCase().includes(query)
      );
      renderUsers(filtered);
    }
    
    // Load chat list
    async function loadChats() {
      try {
        const res = await fetch('/api/messages');
        const chats = await res.json();
        const chatList = document.getElementById('chatList');
        chatList.innerHTML = chats.map(c => `
          <div class="chat-item" onclick="loadChatMessages('${c.chatId}')">
            <h4>${c.chatId}</h4>
            <p>${c.messageCount} messages</p>
          </div>
        `).join('');
      } catch (e) {
        console.error('Failed to load chat list:', e);
      }
    }
    
    async function loadChatMessages(chatId) {
      try {
        const res = await fetch(`/api/messages?chatId=${encodeURIComponent(chatId)}&limit=200`);
        const messages = await res.json();
        const messageList = document.getElementById('messageList');
        messageList.innerHTML = messages.map(m => `
          <div class="message-item">
            <div class="sender">${escapeHtml(m.senderName || m.senderId)}</div>
            <div class="content">${escapeHtml(m.content)}</div>
            <div class="time">${new Date(m.timestamp).toLocaleString()}</div>
          </div>
        `).join('');
      } catch (e) {
        console.error('Failed to load messages:', e);
      }
    }
    
    // Load group chat list
    async function loadRooms() {
      try {
        const res = await fetch('/api/rooms');
        const rooms = await res.json();
        const tbody = document.getElementById('roomTableBody');
        tbody.innerHTML = rooms.map(r => `
          <tr>
            <td>${escapeHtml(r.name)}</td>
            <td>${r.owner}</td>
            <td>${r.members?.length || 0}</td>
            <td>${new Date(r.createdAt).toLocaleString()}</td>
            <td>
              <button class="action-btn" onclick="loadChatMessages('room_${r.id}')">View Messages</button>
            </td>
          </tr>
        `).join('');
      } catch (e) {
        console.error('Failed to load groups:', e);
      }
    }
    
    // Load role list
    async function loadRoles() {
      try {
        const res = await fetch('/api/roles');
        allRoles = await res.json();
        renderRoles();
        updateRoleSelect();
      } catch (e) {
        console.error('Failed to load roles:', e);
      }
    }
    
    function renderRoles() {
      const tbody = document.getElementById('roleTableBody');
      const allRolesList = [
        ...Object.entries(allRoles.builtIn).map(([k, v]) => ({ ...v, key: k, isBuiltIn: true })),
        ...Object.entries(allRoles.custom).map(([k, v]) => ({ ...v, key: k, isBuiltIn: false }))
      ];
      
      tbody.innerHTML = allRolesList.map(r => `
        <tr>
          <td style="color: ${r.color}">${r.key}</td>
          <td>${r.level}</td>
          <td>${r.badge || '-'}</td>
          <td>${r.permissions?.join(', ') || '-'}</td>
          <td>${r.isBuiltIn ? 'Built-in' : 'Custom'}</td>
          <td>
            ${!r.isBuiltIn ? `<button class="action-btn danger" onclick="deleteRole('${r.key}')">Delete</button>` : '-'}
          </td>
        </tr>
      `).join('');
    }
    
    function updateRoleSelect() {
      const select = document.getElementById('roleSelect');
      const allRolesList = [
        ...Object.entries(allRoles.builtIn).filter(([k]) => k !== 'SUPER_ADMIN'),
        ...Object.entries(allRoles.custom)
      ];
      select.innerHTML = allRolesList.map(([k, v]) => 
        `<option value="${k}">${v.badge || k}</option>`
      ).join('');
    }
    
    // Show panel
    function showPanel(panel) {
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById(panel + 'Panel').classList.add('active');
      event.target.classList.add('active');
      
      if (panel === 'users') loadUsers();
      if (panel === 'messages') loadChats();
      if (panel === 'rooms') loadRooms();
      if (panel === 'roles') loadRoles();
    }
    
    // Modal operations
    function showBanModal(odp, name) {
      document.getElementById('banUserOdp').value = odp;
      document.getElementById('banUserName').textContent = name;
      document.getElementById('banModal').classList.add('active');
    }
    
    function showMuteModal(odp, name) {
      document.getElementById('muteUserOdp').value = odp;
      document.getElementById('muteUserName').textContent = name;
      document.getElementById('muteModal').classList.add('active');
    }
    
    function showRoleModal(odp, name, currentRole) {
      document.getElementById('roleUserOdp').value = odp;
      document.getElementById('roleUserName').textContent = name;
      document.getElementById('roleSelect').value = currentRole;
      document.getElementById('roleModal').classList.add('active');
    }
    
    function showPasswordModal(odp, name) {
      document.getElementById('passwordUserOdp').value = odp;
      document.getElementById('passwordUserName').textContent = name;
      document.getElementById('newPasswordInput').value = '';
      document.getElementById('confirmPasswordInput').value = '';
      document.getElementById('passwordModal').classList.add('active');
    }
    
    function showCreateRoleModal() {
      document.getElementById('createRoleModal').classList.add('active');
    }
    
    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
    }
    
    // API operations
    async function confirmBan() {
      const odp = document.getElementById('banUserOdp').value;
      const reason = document.getElementById('banReason').value;
      const durationValue = document.getElementById('banDuration').value;
      
      try {
        await fetch('/api/ban', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            odp,
            reason,
            permanent: durationValue === 'permanent',
            duration: durationValue !== 'permanent' ? parseInt(durationValue) : null
          })
        });
        closeModal('banModal');
        loadUsers();
        loadStats();
      } catch (e) {
        alert('Operation failed');
      }
    }
    
    async function unbanUser(odp) {
      if (!confirm('Are you sure you want to unban this user?')) return;
      try {
        await fetch('/api/unban', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ odp })
        });
        loadUsers();
        loadStats();
      } catch (e) {
        alert('Operation failed');
      }
    }
    
    async function confirmMute() {
      const odp = document.getElementById('muteUserOdp').value;
      const reason = document.getElementById('muteReason').value;
      const durationValue = document.getElementById('muteDuration').value;
      
      try {
        await fetch('/api/mute', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            odp,
            reason,
            permanent: durationValue === 'permanent',
            duration: durationValue !== 'permanent' ? parseInt(durationValue) : null
          })
        });
        closeModal('muteModal');
        loadUsers();
        loadStats();
      } catch (e) {
        alert('Operation failed');
      }
    }
    
    async function unmuteUser(odp) {
      if (!confirm('Are you sure you want to unmute this user?')) return;
      try {
        await fetch('/api/unmute', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ odp })
        });
        loadUsers();
        loadStats();
      } catch (e) {
        alert('Operation failed');
      }
    }
    
    async function confirmSetRole() {
      const odp = document.getElementById('roleUserOdp').value;
      const role = document.getElementById('roleSelect').value;
      
      try {
        await fetch('/api/setRole', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ odp, role })
        });
        closeModal('roleModal');
        loadUsers();
      } catch (e) {
        alert('Operation failed');
      }
    }
    
    async function confirmChangePassword() {
      const odp = document.getElementById('passwordUserOdp').value;
      const newPassword = document.getElementById('newPasswordInput').value;
      const confirmPassword = document.getElementById('confirmPasswordInput').value;
      
      if (!newPassword || newPassword.length < 6) {
        alert('Password must be at least 6 characters');
        return;
      }
      
      if (newPassword !== confirmPassword) {
        alert('Passwords do not match');
        return;
      }
      
      try {
        const res = await fetch('/api/changePassword', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ odp, newPassword })
        });
        const result = await res.json();
        if (result.success) {
          alert(result.message || 'Password changed successfully');
          closeModal('passwordModal');
        } else {
          alert(result.error || 'Operation failed');
        }
      } catch (e) {
        alert('Operation failed');
      }
    }
    
    async function confirmCreateRole() {
      const name = document.getElementById('newRoleName').value.trim();
      const color = document.getElementById('newRoleColor').value;
      const level = parseInt(document.getElementById('newRoleLevel').value);
      const badge = document.getElementById('newRoleBadge').value;
      const permissions = Array.from(document.querySelectorAll('#createRoleModal .permission-item input:checked'))
        .map(cb => cb.value);
      
      if (!name) {
        alert('Please enter a role name');
        return;
      }
      
      try {
        const res = await fetch('/api/roles/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, color, level, badge, permissions })
        });
        
        if (!res.ok) {
          const err = await res.json();
          alert(err.error);
          return;
        }
        
        closeModal('createRoleModal');
        loadRoles();
      } catch (e) {
        alert('Failed to create');
      }
    }
    
    async function deleteRole(name) {
      if (!confirm(`Are you sure you want to delete role "${name}"? Users with this role will be reset to regular users.`)) return;
      
      try {
        await fetch(`/api/roles/${name}`, { method: 'DELETE' });
        loadRoles();
        loadUsers();
      } catch (e) {
        alert('Failed to delete');
      }
    }
    
    async function deleteUser(odp, nickname) {
      if (!confirm(`‚ö†Ô∏è Are you sure you want to permanently delete user "${nickname}"?\n\nThis action cannot be undone and will delete all user data!`)) return;
      
      try {
        const res = await fetch(`/api/users/${odp}`, { method: 'DELETE' });
        
        if (!res.ok) {
          const err = await res.json();
          alert('Failed to delete: ' + err.error);
          return;
        }
        
        alert('User deleted');
        loadStats();
        loadUsers();
      } catch (e) {
        alert('Failed to delete');
      }
    }
    
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // Initialize
    loadStats();
    loadUsers();
    loadRoles();
    
    // Auto refresh
    setInterval(loadStats, 30000);
  </script>
</body>
</html>
