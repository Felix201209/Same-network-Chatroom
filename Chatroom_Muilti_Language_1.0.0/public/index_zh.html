<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>局域网聊天室</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Login Page -->
  <div id="loginPage" class="page active">
    <!-- Language Switch on Login Page -->
    <div class="login-lang-switch">
      <button class="lang-option" data-lang="zh">中文</button>
      <button class="lang-option" data-lang="en">EN</button>
    </div>
    
    <div class="login-container">
      <div class="login-logo">
        <i class="fas fa-comments"></i>
      </div>
      <h1 class="login-title">局域网聊天室</h1>
      <p class="login-subtitle">同一局域网内的设备可以直接连接和聊天</p>
      
      <!-- Login Form -->
      <div class="login-form" id="loginForm">
        <div class="input-group">
          <i class="fas fa-user"></i>
          <input type="text" id="loginUsername" placeholder="用户名" maxlength="20" autocomplete="username">
        </div>
        
        <div class="input-group">
          <i class="fas fa-lock"></i>
          <input type="password" id="loginPassword" placeholder="密码" maxlength="50" autocomplete="current-password">
        </div>
        
        <button id="loginBtn" class="login-btn">
          <span>登录</span>
          <i class="fas fa-arrow-right"></i>
        </button>
        
        <p class="form-switch">还没有账号？ <a href="#" id="showRegisterForm">立即注册</a></p>
      </div>
      
      <!-- Registration Form -->
      <div class="register-form" id="registerForm" style="display: none;">
        <div class="avatar-upload">
          <div class="avatar-preview" id="avatarPreview">
            <i class="fas fa-user"></i>
          </div>
          <label for="avatarInput" class="avatar-upload-btn">
            <i class="fas fa-camera"></i>
          </label>
          <input type="file" id="avatarInput" accept="image/*" hidden>
        </div>
        
        <div class="input-group">
          <i class="fas fa-user"></i>
          <input type="text" id="registerUsername" placeholder="用户名 (3-20个字母或数字)" maxlength="20" autocomplete="username">
        </div>
        
        <div class="input-group">
          <i class="fas fa-id-card"></i>
          <input type="text" id="registerNickname" placeholder="昵称" maxlength="20">
        </div>
        
        <div class="input-group">
          <i class="fas fa-lock"></i>
          <input type="password" id="registerPassword" placeholder="密码 (至少6位，必须包含字母和数字)" maxlength="50" autocomplete="new-password">
        </div>
        <p class="input-hint" id="passwordHint">密码至少需要6个字符，包含字母和数字</p>
        
        <div class="input-group">
          <i class="fas fa-lock"></i>
          <input type="password" id="registerConfirmPassword" placeholder="确认密码" maxlength="50" autocomplete="new-password">
        </div>
        
        <div class="input-group">
          <i class="fas fa-pen"></i>
          <input type="text" id="registerSignature" placeholder="个性签名 (可选)" maxlength="50">
        </div>
        
        <button id="registerBtn" class="login-btn register-btn">
          <span>注册</span>
          <i class="fas fa-user-plus"></i>
        </button>
        
        <p class="form-switch">已有账号？ <a href="#" id="showLoginForm">返回登录</a></p>
      </div>
      
      <div class="server-info">
        <i class="fas fa-info-circle"></i>
        <span>其他设备可通过 <strong id="serverAddress">--</strong> 访问</span>
      </div>
    </div>
  </div>

  <!-- Main Application Page -->
  <div id="mainApp" class="page">
    <!-- Sidebar/Bottom Navigation -->
    <nav class="main-nav">
      <div class="nav-item active" data-tab="chats">
        <i class="fas fa-comment-dots"></i>
        <span>聊天</span>
        <div class="badge" id="chatBadge"></div>
      </div>
      <div class="nav-item" data-tab="contacts">
        <i class="fas fa-users"></i>
        <span>通讯录</span>
      </div>
      <div class="nav-item" data-tab="discover">
        <i class="fas fa-compass"></i>
        <span>发现</span>
      </div>
      <div class="nav-item" data-tab="profile">
        <i class="fas fa-user-circle"></i>
        <span>我</span>
      </div>
    </nav>

    <!-- Content Area -->
    <main class="main-content">
      <!-- Chat List Page -->
      <section id="chatsTab" class="tab-content active">
        <header class="tab-header">
          <h1>聊天</h1>
          <div class="header-actions">
            <button class="icon-btn" id="searchBtn">
              <i class="fas fa-search"></i>
            </button>
            <button class="icon-btn" id="addChatBtn">
              <i class="fas fa-plus"></i>
            </button>
          </div>
        </header>
        
        <!-- Search Bar -->
        <div class="search-bar" id="searchBar">
          <i class="fas fa-search"></i>
          <input type="text" id="searchInput" placeholder="搜索聊天记录">
          <button class="search-cancel" id="searchCancel">取消</button>
        </div>
        
        <div class="chat-list" id="chatList">
          <!-- Chat list items will be generated dynamically -->
          <div class="empty-state" id="emptyChatState">
            <i class="fas fa-comments"></i>
            <p>还没有聊天</p>
            <span>点击右上角开始新对话</span>
          </div>
        </div>
      </section>

      <!-- Contacts List Page -->
      <section id="contactsTab" class="tab-content">
        <header class="tab-header">
          <h1>通讯录</h1>
          <div class="header-actions">
            <button class="icon-btn" id="friendRequestsBtn" onclick="openFriendRequestsPanel()" style="position: relative;">
              <i class="fas fa-user-clock"></i>
              <div class="friend-request-badge" id="friendRequestBadge" style="display: none;">0</div>
            </button>
            <button class="icon-btn" id="addContactBtn">
              <i class="fas fa-user-plus"></i>
            </button>
          </div>
        </header>
        
        <div class="contact-actions">
          <div class="contact-action-item" id="newGroupBtn">
            <div class="action-icon green">
              <i class="fas fa-users"></i>
            </div>
            <span>创建群组</span>
          </div>
          <div class="contact-action-item" id="groupChatsBtn">
            <div class="action-icon blue">
              <i class="fas fa-user-friends"></i>
            </div>
            <span>群组</span>
            <span class="count" id="groupCount">0</span>
          </div>
        </div>
        
        <div class="contact-list" id="contactList">
          <!-- Contact list will be generated dynamically -->
        </div>
        
        <div class="online-count">
          <span id="onlineCount">0</span> 人在线
        </div>
      </section>

      <!-- Discover Page -->
      <section id="discoverTab" class="tab-content">
        <header class="tab-header">
          <h1>发现</h1>
        </header>
        
        <div class="discover-list">
          <div class="discover-item" id="momentsBtn">
            <div class="discover-icon" style="background: linear-gradient(135deg, #FF6B6B, #FF8E53);">
              <i class="fas fa-camera-retro"></i>
            </div>
            <span class="discover-title">朋友圈</span>
            <i class="fas fa-chevron-right"></i>
          </div>
          <div class="discover-item" id="onlineUsersBtn">
            <div class="discover-icon" style="background: linear-gradient(135deg, #4ECDC4, #44A08D);">
              <i class="fas fa-users"></i>
            </div>
            <span class="discover-title">在线用户</span>
            <i class="fas fa-chevron-right"></i>
          </div>
          <div class="discover-item" id="broadcastBtn">
            <div class="discover-icon" style="background: linear-gradient(135deg, #667eea, #764ba2);">
              <i class="fas fa-bullhorn"></i>
            </div>
            <span class="discover-title">公告</span>
            <i class="fas fa-chevron-right"></i>
          </div>
          <div class="discover-item" id="helpBtn">
            <div class="discover-icon" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
              <i class="fas fa-question-circle"></i>
            </div>
            <span class="discover-title">帮助</span>
            <i class="fas fa-chevron-right"></i>
          </div>
          <div class="discover-item" id="gamesBtn" onclick="openGamesModal()">
            <div class="discover-icon" style="background: linear-gradient(135deg, #11998e, #38ef7d);">
              <i class="fas fa-gamepad"></i>
            </div>
            <span class="discover-title">小游戏</span>
            <i class="fas fa-chevron-right"></i>
          </div>
        </div>
      </section>

      <!-- Profile Page -->
      <section id="profileTab" class="tab-content">
        <header class="tab-header">
          <h1>我</h1>
        </header>
        
        <div class="profile-card" id="profileCard">
          <div class="profile-avatar" id="myAvatar">
            <i class="fas fa-user"></i>
          </div>
          <div class="profile-info">
            <h2 id="myNickname">用户</h2>
            <p id="mySignature">这个人很懒，什么都没写</p>
            <span class="user-id">ID: <span id="myUserId">--</span></span>
          </div>
          <i class="fas fa-qrcode profile-qr"></i>
        </div>
        
        <div class="profile-menu">
          <div class="menu-item" id="editProfileBtn">
            <i class="fas fa-user-edit"></i>
            <span>编辑资料</span>
            <i class="fas fa-chevron-right"></i>
          </div>
          <div class="menu-item" id="settingsBtn">
            <i class="fas fa-cog"></i>
            <span>设置</span>
            <i class="fas fa-chevron-right"></i>
          </div>
          <div class="menu-item" id="themeBtn">
            <i class="fas fa-palette"></i>
            <span>主题</span>
            <div class="theme-toggle">
              <input type="checkbox" id="darkModeToggle">
              <label for="darkModeToggle"></label>
            </div>
          </div>
          <div class="menu-item" id="languageBtn">
            <i class="fas fa-globe"></i>
            <span>语言 / Language</span>
            <div class="language-toggle">
              <button class="lang-option active" data-lang="zh">中文</button>
              <button class="lang-option" data-lang="en">English</button>
            </div>
          </div>
          <div class="menu-item" id="aboutBtn">
            <i class="fas fa-info-circle"></i>
            <span>关于</span>
            <i class="fas fa-chevron-right"></i>
          </div>
        </div>
        
        <div class="server-info-card">
          <h3><i class="fas fa-network-wired"></i> 连接信息</h3>
          <p>局域网地址: <strong id="lanAddress">--</strong></p>
          <p>将此地址分享给同一网络的朋友即可加入聊天</p>
        </div>
      </section>
    </main>

    <!-- Chat Window -->
    <div id="chatWindow" class="chat-window">
      <!-- Empty State (shown when no chat selected) -->
      <div class="chat-empty-state" id="chatEmptyState">
        <i class="fas fa-comments"></i>
        <h3>选择一个聊天开始对话</h3>
        <p>从左侧选择好友或群组，开始聊天吧！</p>
      </div>
      
      <header class="chat-header">
        <button class="back-btn" id="backBtn">
          <i class="fas fa-arrow-left"></i>
        </button>
        <div class="chat-info">
          <h2 id="chatTitle">聊天</h2>
          <span class="chat-status" id="chatStatus"></span>
        </div>
        <div class="chat-actions">
          <button class="icon-btn" id="voiceCallBtn">
            <i class="fas fa-phone"></i>
          </button>
          <button class="icon-btn" id="videoCallBtn">
            <i class="fas fa-video"></i>
          </button>
          <button class="icon-btn" id="chatMenuBtn">
            <i class="fas fa-ellipsis-v"></i>
          </button>
        </div>
      </header>
      
      <div class="messages-container" id="messagesContainer">
        <div class="messages-list" id="messagesList">
          <!-- Messages will be generated dynamically -->
        </div>
        
        <!-- Typing Indicator -->
        <div class="typing-indicator" id="typingIndicator">
          <span></span>
          <span></span>
          <span></span>
          <p>正在输入...</p>
        </div>
      </div>
      
      <!-- Reply Preview -->
      <div class="reply-preview" id="replyPreview">
        <div class="reply-content">
          <span class="reply-to">回复 <strong id="replyToName"></strong></span>
          <p id="replyToContent"></p>
        </div>
        <button class="reply-cancel" id="replyCancelBtn">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <!-- Input Area -->
      <div class="input-area">
        <div class="input-tools">
          <button class="tool-btn" id="voiceBtn">
            <i class="fas fa-microphone"></i>
          </button>
        </div>
        
        <div class="input-wrapper">
          <div class="text-input" id="messageInput" contenteditable="true" placeholder="输入消息..."></div>
        </div>
        
        <div class="input-actions">
          <button class="tool-btn" id="emojiBtn">
            <i class="fas fa-smile"></i>
          </button>
          <button class="tool-btn" id="attachBtn">
            <i class="fas fa-plus"></i>
          </button>
          <button class="send-btn" id="sendBtn">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
      
      <!-- Emoji Panel -->
      <div class="emoji-panel" id="emojiPanel">
        <div class="emoji-grid" id="emojiGrid">
          <!-- Emojis will be generated dynamically -->
        </div>
      </div>
      
      <!-- Attachment Panel -->
      <div class="attach-panel" id="attachPanel">
        <div class="attach-grid">
          <div class="attach-item" id="attachImage">
            <div class="attach-icon" style="background: #4CAF50;">
              <i class="fas fa-image"></i>
            </div>
            <span>图片</span>
          </div>
          <div class="attach-item" id="attachCamera">
            <div class="attach-icon" style="background: #2196F3;">
              <i class="fas fa-camera"></i>
            </div>
            <span>拍照</span>
          </div>
          <div class="attach-item" id="attachVideo">
            <div class="attach-icon" style="background: #9C27B0;">
              <i class="fas fa-video"></i>
            </div>
            <span>视频</span>
          </div>
          <div class="attach-item" id="attachFile">
            <div class="attach-icon" style="background: #FF9800;">
              <i class="fas fa-file"></i>
            </div>
            <span>文件</span>
          </div>
          <div class="attach-item" id="attachLocation">
            <div class="attach-icon" style="background: #E91E63;">
              <i class="fas fa-map-marker-alt"></i>
            </div>
            <span>位置</span>
          </div>
          <div class="attach-item" id="attachVoice">
            <div class="attach-icon" style="background: #00BCD4;">
              <i class="fas fa-microphone"></i>
            </div>
            <span>语音</span>
          </div>
        </div>
      </div>
      
      <!-- Voice Recording Interface -->
      <div class="voice-recording" id="voiceRecording">
        <div class="voice-wave">
          <div class="wave-bar"></div>
          <div class="wave-bar"></div>
          <div class="wave-bar"></div>
          <div class="wave-bar"></div>
          <div class="wave-bar"></div>
        </div>
        <p class="recording-time" id="recordingTime">00:00</p>
        <p class="recording-hint">松开发送，上滑取消</p>
      </div>
    </div>

    <!-- Create Group Modal -->
    <div class="modal" id="createGroupModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>创建群组</h2>
          <button class="modal-close" id="closeGroupModal">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="input-group">
            <i class="fas fa-users"></i>
            <input type="text" id="groupNameInput" placeholder="群组名称">
          </div>
          <div class="input-group">
            <i class="fas fa-info-circle"></i>
            <input type="text" id="groupDescInput" placeholder="群组描述 (可选)">
          </div>
          <h3>选择成员</h3>
          <div class="member-select" id="memberSelect">
            <!-- Member selection list -->
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="cancelGroupBtn">取消</button>
          <button class="btn btn-primary" id="confirmGroupBtn">Create</button>
        </div>
      </div>
    </div>

    <!-- Image Preview -->
    <div class="image-preview-modal" id="imagePreviewModal">
      <button class="preview-close" id="closePreview">
        <i class="fas fa-times"></i>
      </button>
      <img id="previewImage" src="" alt="Preview Image">
      <div class="preview-actions">
        <button id="downloadImage"><i class="fas fa-download"></i> 保存</button>
        <button id="forwardImage"><i class="fas fa-share"></i> Forward</button>
      </div>
    </div>

    <!-- Message Context Menu -->
    <div class="context-menu" id="messageContextMenu">
      <div class="menu-item" data-action="reply">
        <i class="fas fa-reply"></i> Reply
      </div>
      <div class="menu-item" data-action="copy">
        <i class="fas fa-copy"></i> Copy
      </div>
      <div class="menu-item" data-action="forward">
        <i class="fas fa-share"></i> Forward
      </div>
      <div class="menu-item" data-action="edit">
        <i class="fas fa-edit"></i> Edit
      </div>
      <div class="menu-item" data-action="delete">
        <i class="fas fa-trash"></i> 删除
      </div>
      <div class="menu-item" data-action="recall">
        <i class="fas fa-undo"></i> Recall
      </div>
    </div>

    <!-- Moments Modal -->
    <div class="modal" id="momentsModal">
      <div class="modal-content modal-fullscreen">
        <div class="modal-header">
          <button class="modal-back" onclick="closeModal('momentsModal')">
            <i class="fas fa-arrow-left"></i>
          </button>
          <h2>Moments</h2>
          <button class="icon-btn" id="postMomentBtn">
            <i class="fas fa-camera"></i>
          </button>
        </div>
        <div class="modal-body moments-body" id="momentsList">
          <!-- Moments content -->
        </div>
      </div>
    </div>

    <!-- Post Moment Modal -->
    <div class="modal" id="postMomentModal">
      <div class="modal-content">
        <div class="modal-header">
          <button class="modal-close" onclick="closeModal('postMomentModal')">
            <i class="fas fa-times"></i>
          </button>
          <h2>Post Update</h2>
          <button class="btn btn-primary btn-sm" id="submitMomentBtn">Post</button>
        </div>
        <div class="modal-body">
          <textarea id="momentContent" placeholder="说点什么吧..." rows="4"></textarea>
          <div class="moment-images" id="momentImages"></div>
          <div class="moment-actions-bar">
            <button class="tool-btn" id="addMomentImage">
              <i class="fas fa-image"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Scan Modal -->
    <div class="modal" id="scanModal">
      <div class="modal-content modal-fullscreen">
        <div class="modal-header">
          <button class="modal-back" onclick="closeModal('scanModal')">
            <i class="fas fa-arrow-left"></i>
          </button>
          <h2>Scan</h2>
          <div></div>
        </div>
        <div class="modal-body scan-body">
          <div class="scan-area">
            <video id="scanVideo" autoplay playsinline></video>
            <div class="scan-overlay">
              <div class="scan-frame">
                <div class="scan-line"></div>
              </div>
            </div>
          </div>
          <p class="scan-hint">Place QR code inside the frame to scan automatically</p>
          <div class="scan-result" id="scanResult"></div>
        </div>
      </div>
    </div>

    <!-- Shake Modal -->
    <div class="modal" id="shakeModal">
      <div class="modal-content modal-fullscreen">
        <div class="modal-header">
          <button class="modal-back" onclick="closeModal('shakeModal')">
            <i class="fas fa-arrow-left"></i>
          </button>
          <h2>Shake</h2>
          <div></div>
        </div>
        <div class="modal-body shake-body">
          <div class="shake-icon" id="shakeIcon">
            <i class="fas fa-mobile-alt"></i>
          </div>
          <p class="shake-hint">Shake your phone to match online users</p>
          <div class="shake-result" id="shakeResult"></div>
        </div>
      </div>
    </div>

    <!-- Nearby People Modal -->
    <div class="modal" id="nearbyModal">
      <div class="modal-content modal-fullscreen">
        <div class="modal-header">
          <button class="modal-back" onclick="closeModal('nearbyModal')">
            <i class="fas fa-arrow-left"></i>
          </button>
          <h2>Nearby</h2>
          <button class="icon-btn" id="refreshNearbyBtn">
            <i class="fas fa-sync-alt"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="nearby-list" id="nearbyList">
            <!-- Nearby people list -->
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Profile Modal -->
    <div class="modal" id="editProfileModal">
      <div class="modal-content">
        <div class="modal-header">
          <button class="modal-close" onclick="closeModal('editProfileModal')">
            <i class="fas fa-times"></i>
          </button>
          <h2>编辑资料</h2>
          <button class="btn btn-primary btn-sm" id="saveProfileBtn">保存</button>
        </div>
        <div class="modal-body">
          <div class="edit-avatar-section">
            <div class="avatar-preview" id="editAvatarPreview">
              <i class="fas fa-user"></i>
            </div>
            <button class="btn btn-secondary btn-sm" id="changeAvatarBtn">Change Avatar</button>
            <input type="file" id="editAvatarInput" accept="image/*" hidden>
          </div>
          <div class="input-group">
            <i class="fas fa-user"></i>
            <input type="text" id="editNickname" placeholder="昵称" maxlength="20">
          </div>
          <div class="input-group">
            <i class="fas fa-pen"></i>
            <input type="text" id="editSignature" placeholder="个性签名" maxlength="50">
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
      <div class="modal-content modal-fullscreen">
        <div class="modal-header">
          <button class="modal-back" onclick="closeModal('settingsModal')">
            <i class="fas fa-arrow-left"></i>
          </button>
          <h2>设置</h2>
          <div></div>
        </div>
        <div class="modal-body">
          <div class="settings-section">
            <h3>Account & Security</h3>
            <div class="menu-item" id="changePasswordBtn">
              <i class="fas fa-lock"></i>
              <span>修改密码</span>
              <i class="fas fa-chevron-right"></i>
            </div>
          </div>
          <div class="settings-section">
            <h3>General</h3>
            <div class="menu-item">
              <i class="fas fa-bell"></i>
              <span>Notifications</span>
              <div class="theme-toggle">
                <input type="checkbox" id="notificationToggle" checked>
                <label for="notificationToggle"></label>
              </div>
            </div>
            <div class="menu-item">
              <i class="fas fa-volume-up"></i>
              <span>Sound</span>
              <div class="theme-toggle">
                <input type="checkbox" id="soundToggle" checked>
                <label for="soundToggle"></label>
              </div>
            </div>
          </div>
          <div class="settings-section">
            <h3>Storage</h3>
            <div class="menu-item" id="clearCacheBtn">
              <i class="fas fa-trash-alt"></i>
              <span>清除缓存</span>
              <i class="fas fa-chevron-right"></i>
            </div>
          </div>
          <button class="btn btn-danger logout-btn" id="logoutBtn">退出登录</button>
        </div>
      </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal" id="changePasswordModal">
      <div class="modal-content">
        <div class="modal-header">
          <button class="modal-close" onclick="closeModal('changePasswordModal')">
            <i class="fas fa-times"></i>
          </button>
          <h2>修改密码</h2>
          <button class="btn btn-primary btn-sm" id="submitPasswordBtn">确认</button>
        </div>
        <div class="modal-body">
          <div class="input-group">
            <i class="fas fa-lock"></i>
            <input type="password" id="oldPassword" placeholder="当前密码">
          </div>
          <div class="input-group">
            <i class="fas fa-lock"></i>
            <input type="password" id="newPassword" placeholder="新密码 (至少6位，字母和数字)">
          </div>
          <div class="input-group">
            <i class="fas fa-lock"></i>
            <input type="password" id="confirmNewPassword" placeholder="确认新密码">
          </div>
        </div>
      </div>
    </div>

    <!-- About Modal -->
    <div class="modal" id="aboutModal">
      <div class="modal-content">
        <div class="modal-header">
          <button class="modal-close" onclick="closeModal('aboutModal')">
            <i class="fas fa-times"></i>
          </button>
          <h2>About</h2>
          <div></div>
        </div>
        <div class="modal-body about-body">
          <div class="about-logo">
            <i class="fas fa-comments"></i>
          </div>
          <h3>LAN Chat Room</h3>
          <p class="version">Version 1.0.0</p>
          <p class="description">A simple and elegant LAN instant messaging tool. (Made for fun)</p>
          <div class="about-links">
            <p>Devices on the same LAN can connect directly via IP address</p>
            <p>Why are you reading this anyway?</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
      <i class="toast-icon"></i>
      <span class="toast-message"></span>
    </div>

    <!-- Friend Requests Panel -->
    <div class="panel-overlay" id="friendRequestsOverlay" onclick="closeFriendRequestsPanel()"></div>
    <div class="friend-requests-panel" id="friendRequestsPanel">
      <div class="friend-requests-header">
        <h3>好友请求</h3>
        <button class="close-requests-btn" onclick="closeFriendRequestsPanel()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="friend-requests-list" id="friendRequestsList">
        <div class="empty-state" id="emptyRequestsState">
          <i class="fas fa-user-plus"></i>
          <p>No friend requests</p>
        </div>
      </div>
    </div>

    <!-- Group Settings Panel -->
    <div class="panel-overlay" id="roomSettingsOverlay" onclick="closeRoomSettingsPanel()"></div>
    <div class="room-settings-panel" id="roomSettingsPanel">
      <div class="room-settings-header">
        <h3>群组设置</h3>
        <button class="close-requests-btn" onclick="closeRoomSettingsPanel()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="room-settings-content">
        <!-- Group Avatar -->
        <div class="settings-section" id="roomAvatarSection">
          <h4>Group Avatar</h4>
          <div class="room-avatar-wrapper" onclick="uploadRoomAvatar()">
            <div class="room-avatar" id="roomAvatarDisplay">
              <i class="fas fa-users"></i>
            </div>
            <span class="edit-hint">Click to change</span>
          </div>
          <input type="file" id="roomAvatarInput" accept="image/*" hidden onchange="handleRoomAvatarUpload(event)">
        </div>
        
        <div class="settings-section" id="roomNameSection">
          <h4>Group Name</h4>
          <div class="input-group">
            <input type="text" id="roomNameInput" placeholder="群组名称">
          </div>
          <button class="add-friend-btn" style="margin-top: 8px;" onclick="saveRoomName()">保存</button>
        </div>
        
        <!-- Group Announcement -->
        <div class="settings-section" id="roomAnnouncementSection">
          <h4>Announcement</h4>
          <textarea id="roomAnnouncementInput" placeholder="Enter announcement content..." rows="3" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: var(--radius-sm); resize: vertical;"></textarea>
          <button class="add-friend-btn" style="margin-top: 8px;" onclick="saveRoomAnnouncement()">Publish</button>
        </div>
        
        <div class="settings-section">
          <h4>Invite Friends</h4>
          <button class="add-friend-btn" onclick="openInviteMembersModal()">
            <i class="fas fa-user-plus"></i> Invite Friends
          </button>
        </div>
        
        <div class="settings-section">
          <h4>Members <span id="memberCountBadge" style="color: var(--text-muted); font-weight: normal;"></span></h4>
          <div id="roomMembersList">
            <!-- Member list generated dynamically -->
          </div>
        </div>
        
        <!-- Leave/Disband Group -->
        <div class="settings-section" style="border-top: 1px solid var(--border); padding-top: 16px;">
          <button class="danger-btn" id="leaveRoomBtn" onclick="leaveOrDisbandRoom()" style="width: 100%; padding: 12px; background: #FF6B6B; color: white; border: none; border-radius: var(--radius-sm); cursor: pointer;">
            退出群组
          </button>
        </div>
      </div>
    </div>

    <!-- Invite Members Modal -->
    <div class="modal" id="inviteMembersModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>邀请好友</h2>
          <button class="modal-close" onclick="closeModal('inviteMembersModal')">&times;</button>
        </div>
        <div class="modal-body">
          <div id="inviteMembersList" class="member-select-list">
            <!-- Friend list generated dynamically -->
          </div>
        </div>
        <div class="modal-footer">
          <button class="add-friend-btn" onclick="inviteSelectedMembers()">确认邀请</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Hidden File Inputs -->
  <input type="file" id="imageInput" accept="image/*" hidden>
  <input type="file" id="videoInput" accept="video/*" hidden>
  <input type="file" id="fileInput" hidden>
  <input type="file" id="cameraInput" accept="image/*" capture="environment" hidden>
  <input type="file" id="momentImageInput" accept="image/*" multiple hidden>

  <!-- Game Center Modal -->
  <div class="modal" id="gamesModal">
    <div class="modal-content games-modal">
      <div class="modal-header">
        <h2><i class="fas fa-gamepad"></i> 游戏中心</h2>
        <button class="modal-close" onclick="closeModal('gamesModal')">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="games-grid">
          <div class="game-card" onclick="selectGame('gomoku')">
            <div class="game-icon" style="background: linear-gradient(135deg, #667eea, #764ba2);">
              <i class="fas fa-chess-board"></i>
            </div>
            <h3>五子棋</h3>
            <p>和朋友对战，先连成五子者获胜</p>
          </div>
          <div class="game-card" onclick="selectGame('tictactoe')">
            <div class="game-icon" style="background: linear-gradient(135deg, #11998e, #38ef7d);">
              <i class="fas fa-hashtag"></i>
            </div>
            <h3>井字棋</h3>
            <p>经典三子棋，简单有趣</p>
          </div>
          <div class="game-card" onclick="selectGame('guess')">
            <div class="game-icon" style="background: linear-gradient(135deg, #FF6B6B, #FF8E53);">
              <i class="fas fa-question"></i>
            </div>
            <h3>猜数字</h3>
            <p>猜测对手设定的数字</p>
          </div>
          <div class="game-card" onclick="selectGame('rps')">
            <div class="game-icon" style="background: linear-gradient(135deg, #4ECDC4, #44A08D);">
              <i class="fas fa-hand-rock"></i>
            </div>
            <h3>石头剪刀布</h3>
            <p>三局两胜，经典对决</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Invite Friend to Game Modal -->
  <div class="modal" id="gameInviteModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2><i class="fas fa-user-plus"></i> 邀请好友</h2>
        <button class="modal-close" onclick="closeModal('gameInviteModal')">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <p class="invite-hint">选择一个好友玩 <span id="selectedGameName">游戏</span></p>
        <div class="friend-list-for-game" id="friendListForGame">
          <!-- Friend list generated dynamically -->
        </div>
      </div>
    </div>
  </div>

  <!-- Game Panel -->
  <div class="game-panel" id="gamePanel">
    <div class="game-header">
      <button class="back-btn" onclick="closeGamePanel()">
        <i class="fas fa-arrow-left"></i>
      </button>
      <div class="game-title" id="gamePanelTitle">游戏</div>
      <div class="game-status" id="gameStatus">等待中</div>
    </div>
    <div class="game-content" id="gameContent">
      <!-- Game content generated dynamically -->
    </div>
    <div class="game-controls" id="gameControls">
      <!-- Game control buttons -->
    </div>
  </div>

  <!-- Game Invite Toast -->
  <div class="game-invite-toast" id="gameInviteToast">
    <div class="invite-info">
      <div class="invite-avatar" id="inviteAvatar">
        <i class="fas fa-user"></i>
      </div>
      <div class="invite-text">
        <p class="invite-from" id="inviteFrom">某人</p>
        <p class="invite-game">邀请你玩 <span id="inviteGame">游戏</span></p>
      </div>
    </div>
    <div class="invite-actions">
      <button class="accept-invite" onclick="acceptGameInvite()">
        <i class="fas fa-check"></i> 接受
      </button>
      <button class="decline-invite" onclick="declineGameInvite()">
        <i class="fas fa-times"></i> 拒绝
      </button>
    </div>
  </div>

  <!-- Version Info -->
  <div class="version-info">v1.0.0</div>

  <script src="/socket.io/socket.io.js"></script>
  
  <!-- 自动登录脚本 - 必须在 script.js 之前 -->
  <script>
  (async function() {
    try {
      console.log('[内联脚本] 开始检查自动登录...');
      const res = await fetch('/api/auto-login');
      const data = await res.json();
      
      if (data.autoLogin && data.user) {
        console.log('[内联脚本] ✅ 检测到自动登录，保存用户数据');
        localStorage.setItem('chatroom_user', JSON.stringify(data.user));
        localStorage.setItem('auto_login_success', 'true');
        window._autoLoginUser = data.user;
        
        // 立即或在 DOMContentLoaded 时切换页面
        function switchToMainPage() {
          console.log('[内联脚本] 执行页面切换...');
          const loginPage = document.getElementById('loginPage');
          const mainApp = document.getElementById('mainApp');
          
          console.log('[内联脚本] loginPage:', loginPage);
          console.log('[内联脚本] mainApp:', mainApp);
          
          if (loginPage && mainApp) {
            loginPage.style.display = 'none';
            loginPage.classList.remove('active');
            mainApp.style.display = 'flex';
            mainApp.classList.add('active');
            console.log('[内联脚本] ✅ 页面已切换到主界面');
          } else {
            console.error('[内联脚本] ❌ 找不到页面元素！');
          }
        }
        
        // 如果 DOM 已经加载完成，立即切换
        if (document.readyState === 'loading') {
          console.log('[内联脚本] DOM 正在加载，等待 DOMContentLoaded');
          document.addEventListener('DOMContentLoaded', switchToMainPage);
        } else {
          console.log('[内联脚本] DOM 已加载完成，立即切换');
          switchToMainPage();
        }
      } else {
        console.log('[内联脚本] 非本地访问，显示登录页面');
      }
    } catch (e) {
      console.error('[内联脚本] 自动登录检查失败:', e);
    }
  })();
  </script>
  
  <script src="lang-switch.js?v=20251215"></script>
  <script src="script.js?v=20251215"></script>
</body>
</html>
